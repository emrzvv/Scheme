(define (def vec ind)
  (if (equal? (vector-ref vec ind) 'end)
      (+ ind 1)
      (def vec (+ ind 1))))

(define (iff vec ind s)
  (if (equal? s 0)
      ind
      (if (equal? (vector-ref vec ind) 'if)
          (iff vec (+ 1 ind) (- s 1))
          (if (equal? (vector-ref vec ind) 'endif)
              (iff vec (+ 1 ind) (- s 1))
              (iff vec (+ 1 ind) s)))))

(define (interpret vec stack)
  (define (point ind stack return dictionary)
    (if (= ind (vector-length vec))
        stack
        (let ((elem (vector-ref vec ind)))
          (cond
            ((number? elem) (point (+ 1 ind) (cons elem stack) return dictionary))
            ((equal? elem 'drop) (point (+ 1 ind) (cdr stack) return dictionary))
            ((equal? elem 'swap) (point (+ 1 ind) (cons (cadr stack) (cons (car stack) (cddr stack))) return dictionary))
            ((equal? elem 'dup) (point (+ 1 ind) (cons (car stack) stack) return dictionary))
            ((equal? elem 'over) (point (+ 1 ind) (cons (cadr stack) stack) return dictionary))
            ((equal? elem 'rot) (point (+ 1 ind) (append (list (caddr stack) (cadr stack)) (cdddr stack)) return dictionary))
            ((equal? elem 'depth) (point (+ 1 ind) (cons (length stack) stack) return dictionary))
            ((equal? elem '=) (point (+ 1 ind) (cons (if (= (cadr stack) (car stack)) -1 0) (cddr stack)) return dictionary))
            ((equal? elem '>) (point (+ 1 ind) (cons (if (> (cadr stack) (car stack)) -1 0) (cddr stack)) return dictionary))
            ((equal? elem '<) (point (+ 1 ind) (cons (if (< (cadr stack) (car stack)) -1 0) (cddr stack)) return dictionary))
            ((equal? elem '+) (point (+ 1 ind) (cons (+ (cadr stack) (car stack)) (cddr stack)) return dictionary))
            ((equal? elem '-) (point (+ 1 ind) (cons (- (cadr stack) (car stack)) (cddr stack)) return dictionary))
            ((equal? elem '*) (point (+ 1 ind) (cons (* (cadr stack) (car stack)) (cddr stack)) return dictionary))
            ((equal? elem '/) (point (+ 1 ind) (cons (/ (cadr stack) (car stack)) (cddr stack)) return dictionary))
            ((equal? elem 'mod) (point (+ 1 ind) (cons (remainder (cadr stack) (car stack)) (cddr stack)) return dictionary))
            ((equal? elem 'neg) (point (+ 1 ind) (cons (- (car stack)) (cdr stack)) return dictionary))
            ((equal? elem 'and) (point (+ 1 ind) (cons (if (and (= (car stack) -1) (= (cadr stack) -1)) -1 0)) return dictionary))
            ((equal? elem 'or) (point (+ 1 ind) (cons (if (or (= (car stack) -1) (= (cadr stack) -1)) -1 0)) return dictionary))
            ((equal? elem 'define) (point (def vec ind) stack return (cons (list (vector-ref vec (+ ind 1)) (+ ind 2)) dictionary)))
            ((or (equal? elem 'end) (equal? elem 'exit)) (point (car return) stack (cdr return) dictionary))
            ((equal? elem 'if) (point (if (not (= (car stack) 0)) (+ ind 1) (iff vec (+ ind 1) 1)) (cdr stack) return dictionary))
            ((equal? elem 'endif) (point (+ ind 1) stack return dictionary))
            (else (point (cadr (assoc elem dictionary)) stack (cons (+ 1 ind) return) dictionary))))))
  (point 0 stack '() '()))

